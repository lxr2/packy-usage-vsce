name: Release VS Code Extension

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

permissions:
  contents: write  # åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶éœ€è¦å†™æƒé™
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Get tag name and version
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "vsix_file=packy-usage-$VERSION.vsix" >> $GITHUB_OUTPUT
        
      - name: Verify version consistency
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.tag.outputs.version }}"
          echo "Package version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch: package.json($PACKAGE_VERSION) != tag($TAG_VERSION)"
            exit 1
          fi
          echo "âœ… Version consistency check passed"
        
      - name: Compile TypeScript
        run: npm run compile
        
      - name: Run tests
        run: npm run test
        continue-on-error: true  # æµ‹è¯•å¤±è´¥ä¸é˜»æ–­æ„å»º
        
      - name: Package extension
        run: pnpm run package
        
      - name: Verify VSIX file exists
        run: |
          if [ ! -f "${{ steps.tag.outputs.vsix_file }}" ]; then
            echo "âŒ VSIX file not found: ${{ steps.tag.outputs.vsix_file }}"
            ls -la *.vsix || echo "No .vsix files found"
            exit 1
          fi
          echo "âœ… VSIX file verified: ${{ steps.tag.outputs.vsix_file }}"
        
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## ğŸš€ Release ${{ steps.tag.outputs.tag }}
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            
            1. **ä» Release ä¸‹è½½**ï¼šä¸‹è½½ `.vsix` æ–‡ä»¶ï¼Œç„¶ååœ¨ VS Code ä¸­ä½¿ç”¨ `Extensions: Install from VSIX` å‘½ä»¤å®‰è£…
            2. **å‘½ä»¤è¡Œå®‰è£…**ï¼š
               ```bash
               code --install-extension ${{ steps.tag.outputs.vsix_file }}
               ```
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/94mashiro/packy-usage-vsce/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/94mashiro/packy-usage-vsce/issues) ä¸­åé¦ˆ
          files: ${{ steps.tag.outputs.vsix_file }}
          draft: false
          prerelease: false
          
      - name: Publish to VS Code Marketplace
        if: true  # è®¾ç½®ä¸º false ç¦ç”¨è‡ªåŠ¨å‘å¸ƒåˆ°å¸‚åœº
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          echo "ğŸš€ Publishing to VS Code Marketplace..."
          if npx @vscode/vsce publish --pat $VSCE_PAT; then
            echo "âœ… Successfully published to Marketplace"
          else
            echo "âŒ Failed to publish to Marketplace, but GitHub Release was created successfully"
            exit 1
          fi